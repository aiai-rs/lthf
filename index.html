<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HY å®¢æœæ€»æ§å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { background-color: #f8fafc; overflow: hidden; font-family: -apple-system, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-enter { animation: enter 0.2s ease-out forwards; }
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-active .sidebar { display: none; }
        .mobile-active .chat-area { display: flex; }
        @media (min-width: 768px) { .mobile-active .sidebar { display: flex; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const SOCKET_URL = "https://lt-1li6.onrender.com"; 
        
        const NOTIFICATION_SOUND = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjgzLjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAABAAAAAAAAAAAAkJAAAgAAAABBjatLUkAAALiI1yUIAAAAAA//uQZAAABHpWUNzgAAIE6sobnAAACW1lS+w8AAiVrKl9h4AAAD/8z/8///4v/9P/8v8Z///4iH/////5MAAiAAACAAAAABAA8AAAAA//uQZAEABdZRVH5gAAl1lKU/mAAAggVlS+w8AAhxrKl9h4AAAAv///4DAAEAJgAOAFAAbAB8AIAAxADoAPABSAHAAgACWAKgArAC8AMQA0gDeAOwA+gEIAQwBGgEgASgBLAEyAToBQAFIAT4BRAFQAVgBXAFkAWgBcAF4AYABiAGMAZgBoAGoAbABuAHAAcgB0AHYAxQD9AP8BAQEDAv///wAAAAAA";

        function App() {
            const [view, setView] = useState('login');
            const [password, setPassword] = useState('');
            const [users, setUsers] = useState([]);
            const [activeUser, setActiveUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isMobile, setIsMobile] = useState(false);
            
            const socketRef = useRef();
            const scrollRef = useRef();
            const fileInputRef = useRef();
            const audioRef = useRef(new Audio(NOTIFICATION_SOUND));

            // ç™»å½•
            const handleLogin = async () => {
                try {
                    const res = await fetch(`${SOCKET_URL}/api/admin/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ password })
                    });
                    if ((await res.json()).success) {
                        setView('dashboard');
                        initSocket();
                    } else alert("å¯†ç é”™è¯¯");
                } catch { alert("è¿æ¥å¤±è´¥"); }
            };

            // åˆå§‹åŒ–è¿æ¥
            const initSocket = () => {
                fetch(`${SOCKET_URL}/api/admin/users`).then(r=>r.json()).then(setUsers);
                socketRef.current = io(SOCKET_URL);
                socketRef.current.emit('join', { isAdmin: true });
                
                socketRef.current.on('admin_receive_message', (msg) => {
                    audioRef.current.play().catch(()=>{});
                    
                    // 1. å¦‚æœæ­£åœ¨èŠè¿™ä¸ªäººï¼Œè¿½åŠ æ¶ˆæ¯
                    // æ³¨æ„ï¼šè¿™é‡Œç”¨äº†å‡½æ•°å¼æ›´æ–°ï¼Œè§£å†³äº†æ—§ä»£ç ä¸åˆ·æ–°çš„bug
                    if (activeUser && activeUser.id === msg.userId) {
                        setMessages(prev => {
                            // é˜²æ­¢é‡å¤æ·»åŠ  (å¦‚æœæ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œå‰é¢å·²ç»ä¹è§‚æ›´æ–°æ·»åŠ è¿‡äº†)
                            if (!msg.isFromUser && prev.some(m => m.tempId === msg.tempId)) return prev;
                            return [...prev, msg];
                        });
                    }

                    // 2. åˆ—è¡¨ç½®é¡¶
                    setUsers(prev => {
                        const others = prev.filter(u => u.id !== msg.userId);
                        const target = prev.find(u => u.id === msg.userId) || { id: msg.userId, bossId: msg.bossId };
                        return [{...target, updatedAt: new Date(), messages: [{content: msg.content}]}, ...others];
                    });
                });
            };

            // é€‰äºº
            const selectUser = async (user) => {
                setActiveUser(user);
                if (window.innerWidth < 768) setIsMobile(true);
                const res = await fetch(`${SOCKET_URL}/api/history/${user.id}`);
                setMessages(await res.json());
            };

            // å‘é€æ ¸å¿ƒé€»è¾‘ (æ”¯æŒæ–‡æœ¬å’Œå›¾ç‰‡)
            const send = (content, type = 'text') => {
                if (!activeUser) return;
                
                const tempId = Date.now(); // ä¸´æ—¶IDç”¨äºå»é‡
                const msgData = { 
                    userId: activeUser.id, // è¿™é‡Œåªæ˜¯ä¸ºäº†å­˜å‰ç«¯çŠ¶æ€
                    content, 
                    type,
                    isFromUser: false, 
                    createdAt: new Date(),
                    tempId 
                };

                // ğŸ”¥ ä¹è§‚æ›´æ–°ï¼šç«‹åˆ»ä¸Šå±ï¼Œä¸ç­‰æœåŠ¡å™¨
                setMessages(prev => [...prev, msgData]);
                setInput("");

                // å‘ç»™æœåŠ¡å™¨
                socketRef.current.emit('admin_reply', { 
                    targetUserId: activeUser.id, 
                    content,
                    tempId
                });
            };

            // å›¾ç‰‡ä¸Šä¼ å¤„ç†
            const handleImage = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => send(evt.target.result, 'image');
                reader.readAsDataURL(file);
                e.target.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤å‘åŒä¸€å¼ 
            };

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // === ç™»å½•é¡µ ===
            if (view === 'login') return (
                <div className="h-screen flex items-center justify-center bg-slate-100">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-80">
                        <h1 className="text-xl font-bold mb-4 text-center">æ€»æ§å°ç™»å½•</h1>
                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} 
                            className="w-full border p-3 rounded-lg mb-4 text-center text-lg outline-none focus:border-blue-500" placeholder="å¯†ç " />
                        <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">è¿›å…¥ç³»ç»Ÿ</button>
                    </div>
                </div>
            );

            // === èŠå¤©é¡µ ===
            return (
                <div className={`h-[100dvh] flex bg-white ${isMobile ? 'mobile-active' : ''}`}>
                    {/* å·¦ä¾§åˆ—è¡¨ */}
                    <div className="sidebar w-full md:w-80 border-r flex-col z-10 bg-white">
                        <div className="h-14 border-b flex items-center px-4 font-bold bg-slate-50">
                            æ¶ˆæ¯åˆ—è¡¨ <span className="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">{users.length}</span>
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            {users.map(u => (
                                <div key={u.id} onClick={() => selectUser(u)} 
                                    className={`p-3 border-b hover:bg-slate-50 cursor-pointer ${activeUser?.id === u.id ? 'bg-blue-50' : ''}`}>
                                    <div className="flex justify-between">
                                        <div className="font-bold text-sm text-slate-700">
                                            <span className="bg-slate-200 px-1 rounded text-xs mr-1">{u.bossId||'æ— '}</span>
                                            {u.id.slice(0,6)}..
                                        </div>
                                        <div className="text-xs text-slate-400">{new Date(u.updatedAt).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                                    </div>
                                    <div className="text-xs text-slate-500 truncate mt-1">
                                        {u.messages?.[0]?.content.includes('data:image') ? '[å›¾ç‰‡]' : u.messages?.[0]?.content}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* å³ä¾§èŠå¤© */}
                    <div className="chat-area flex-1 flex flex-col relative bg-slate-50">
                        {activeUser ? (
                            <>
                                <div className="h-14 bg-white border-b flex items-center px-4 shadow-sm shrink-0 justify-between">
                                    <div className="flex items-center gap-2">
                                        <button onClick={()=>setIsMobile(false)} className="md:hidden p-1 bg-slate-100 rounded">â¬…ï¸</button>
                                        <span className="font-bold">{activeUser.id}</span>
                                        <span className="text-xs bg-green-100 text-green-700 px-2 rounded">æ¥æº: {activeUser.bossId}</span>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex ${!m.isFromUser ? 'justify-end' : 'justify-start'} animate-enter`}>
                                            <div className={`max-w-[80%] p-3 rounded-xl shadow-sm ${!m.isFromUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border rounded-tl-none'}`}>
                                                {m.content.includes('data:image') ? (
                                                    <img src={m.content} className="rounded-lg max-h-60" />
                                                ) : <p className="whitespace-pre-wrap break-words">{m.content}</p>}
                                                <div className="text-[10px] opacity-60 text-right mt-1">
                                                    {new Date(m.createdAt).toLocaleTimeString()}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={scrollRef}></div>
                                </div>

                                <div className="p-3 bg-white border-t flex gap-2 items-end pb-safe">
                                    {/* å›¾ç‰‡æŒ‰é’® */}
                                    <label className="p-3 text-slate-500 hover:bg-slate-100 rounded-full cursor-pointer">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        <input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImage} />
                                    </label>
                                    
                                    <textarea rows="1" value={input} onChange={e=>setInput(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), send(input))}
                                        className="flex-1 bg-slate-100 p-3 rounded-xl outline-none resize-none max-h-24" placeholder="å›å¤..." />
                                        
                                    <button onClick={() => send(input)} className="bg-blue-600 text-white p-3 rounded-xl font-bold disabled:opacity-50" disabled={!input.trim()}>
                                        å‘é€
                                    </button>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-slate-400">è¯·é€‰æ‹©å·¦ä¾§å®¢æˆ·</div>
                        )}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
